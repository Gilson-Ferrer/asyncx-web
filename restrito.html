<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASYNCX | Portal do Cliente</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #111827; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(0, 0, 0, 0.04); }
        .premium-shadow { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        .status-pago { color: #10b981; background-color: #f0fdf4; border-color: #bbf7d0; }
        .status-pendente { color: #d97706; background-color: #fffbeb; border-color: #fef3c7; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-green {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .led-pulse { animation: pulse-green 2s infinite; color: #22c55e; } /* Verde Tailwind */
        .led-fixed { color: #2563eb; } /* Azul Tailwind */
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-gray-100 h-24">
        <div class="max-w-7xl mx-auto px-6 h-full flex justify-between items-center">
            <a href="index.html"><img src="logo.png" alt="ASYNCX" class="h-12 md:h-14 w-auto"></a> 
            <button id="btnSair" onclick="sair()" class="hidden bg-black text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-gray-800 transition shadow-lg">
                Sair
            </button>
        </div>
    </nav>
<main id="loginSection" class="flex-grow flex items-center justify-center px-6 py-12 fade-in bg-gray-100">
    <div class="w-full max-w-sm">
        <div class="text-center mb-10">
            <span id="labelAcesso" class="text-blue-600 font-bold tracking-[0.3em] text-[10px] uppercase mb-4 block">Acesso Restrito</span>
            <h2 id="tituloAcesso" class="text-4xl font-black tracking-tighter leading-tight">Painel de <br>Seguran√ßa</h2>
        </div>
        
        <div id="loginFields" class="space-y-4">
            <input type="email" id="email" placeholder="E-mail" class="w-full p-5 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 uppercase text-[10px] font-bold">
            
            <div class="relative">
                <input type="password" id="senha" placeholder="Sua Senha" class="w-full p-5 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 pr-14">
                <button type="button" onclick="toggleView('senha')" class="absolute right-5 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600 transition-colors">
                    <svg id="eye-icon-senha" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.644C3.399 8.049 7.21 5 12 5c4.789 0 8.601 3.049 9.964 6.678a1.012 1.012 0 010 .644C20.6 15.951 16.79 19 12 19c-4.789 0-8.601-3.049-9.964-6.678z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>

            <input type="text" id="mfaTokenLogin" placeholder="C√≥digo Authenticator" maxlength="6" class="w-full p-5 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 text-center font-bold tracking-[0.5em]">
            
            <button onclick="fazerLogin()" id="btnLogin" class="w-full bg-blue-600 text-white py-5 rounded-full text-xs font-black uppercase tracking-widest hover:bg-blue-700 transition shadow-xl shadow-blue-100">
                Entrar
            </button>

            <div class="text-center mt-6">
                <a href="javascript:void(0)" onclick="toggleEsqueciSenha(true)" class="text-[10px] text-gray-400 uppercase font-bold hover:text-blue-600 transition">Esqueci minha senha</a>
            </div>
        </div>

        <div id="forgotSection" class="hidden space-y-4 fade-in">
            <div class="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm">
                <p class="text-[10px] font-black uppercase tracking-widest text-center text-gray-400 mb-4">Redefini√ß√£o de Acesso</p>
                <input type="email" id="emailForgot" placeholder="DIGITE SEU E-MAIL CADASTRADO" class="w-full p-5 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 uppercase text-[10px] font-bold">
                
                <button id="btnForgot" onclick="solicitarReset()" class="w-full bg-black text-white py-5 rounded-full text-xs font-black uppercase tracking-widest hover:bg-blue-600 transition shadow-lg mt-4">
                    Enviar Link de Recupera√ß√£o
                </button>
            </div>
            
            <button onclick="toggleEsqueciSenha(false)" class="w-full text-[10px] text-gray-400 uppercase font-bold py-2 hover:text-black transition">
                ‚Üê Voltar para o Login
            </button>
        </div>
    </div>
</main>
<main id="setupSection" class="hidden flex-grow flex items-center justify-center px-6 py-12 fade-in bg-white">
    <div class="w-full max-w-md text-center">
        <span class="text-blue-600 font-bold tracking-[0.3em] text-[10px] uppercase mb-4 block italic">Seguran√ßa ASYNCX</span>
        <h2 id="setupNome" class="text-3xl font-black tracking-tighter mb-8 uppercase text-gray-800">Carregando...</h2>
        
        <div class="glass p-8 rounded-[40px] premium-shadow border-blue-100 border flex flex-col items-center">
            
            <div id="mfaContainer" class="w-full flex flex-col items-center">
                <p class="text-[10px] text-gray-400 mb-6 font-black uppercase tracking-widest">Vincular Dispositivo</p>
                
                <div class="bg-white p-4 rounded-3xl border border-gray-100 mb-6 shadow-inner">
                    <img id="qrCodeImg" src="" alt="MFA QR Code" class="w-48 h-48">
                </div>

                <div class="flex gap-4 mb-8">
                    <a href="https://apps.apple.com/br/app/google-authenticator/id388497605" target="_blank" class="opacity-50 hover:opacity-100 transition">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Download_on_the_App_Store_Badge.svg" class="h-8">
                    </a>
                    <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" target="_blank" class="opacity-50 hover:opacity-100 transition">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" class="h-8">
                    </a>
                </div>
            </div>

            <div class="w-full space-y-4 text-left">
                <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest text-center mb-2">Definir Nova Senha</p>
                
                <p class="text-[9px] text-blue-600 font-bold uppercase tracking-tighter text-center leading-relaxed mb-4">
                    A senha dever√° conter no m√≠nimo 8 caracteres,<br>contendo 1 letra mai√∫scula, 1 n√∫mero e 1 caracter especial.
                </p>

                <div class="relative">
                    <input type="password" id="setupSenha" placeholder="Nova Senha" class="w-full p-4 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 pr-12">
                    <button type="button" onclick="toggleView('setupSenha')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.644C3.399 8.049 7.21 5 12 5c4.789 0 8.601 3.049 9.964 6.678a1.012 1.012 0 010 .644C20.6 15.951 16.79 19 12 19c-4.789 0-8.601-3.049-9.964-6.678z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>

                <div class="relative">
                    <input type="password" id="setupSenhaConfirm" placeholder="Confirme a Senha" class="w-full p-4 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 pr-12">
                    <button type="button" onclick="toggleView('setupSenhaConfirm')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.644C3.399 8.049 7.21 5 12 5c4.789 0 8.601 3.049 9.964 6.678a1.012 1.012 0 010 .644C20.6 15.951 16.79 19 12 19c-4.789 0-8.601-3.049-9.964-6.678z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="w-full mt-8">
                <p class="text-[10px] text-gray-400 mb-4 font-bold uppercase text-center">Digite o c√≥digo de 6 d√≠gitos gerado:</p>
                <input type="text" id="setupMfa" placeholder="000 000" maxlength="6" class="w-full p-4 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-600 transition border border-gray-100 text-center text-xl font-bold tracking-[0.5em]">
            </div>

            <button onclick="finalizarSetup()" id="btnFinalizar" class="w-full bg-black text-white py-5 rounded-full text-xs font-black uppercase tracking-widest hover:bg-blue-600 transition shadow-xl mt-8">
                Finalizar Ativa√ß√£o
            </button>
        </div>
    </div>
</main>
<main id="dashboardSection" class="hidden max-w-7xl mx-auto px-6 py-16 w-full fade-in">
    <div class="mb-12 text-center md:text-left">
        <span class="text-blue-600 font-bold tracking-[0.3em] text-[10px] uppercase mb-2 block">Relat√≥rio em Tempo Real</span>
        <h2 id="clienteNome" class="text-2xl md:text-4xl font-medium tracking-tight text-gray-800 uppercase">---</h2>
        <div class="h-1 bg-blue-600 w-16 mt-4 mx-auto md:mx-0"></div>
    </div>

    <div class="flex gap-4 mb-10 border-b border-gray-100 overflow-x-auto pb-2 no-scrollbar">
        <button onclick="switchTab('tab-docs')" class="tab-btn border-b-2 border-blue-600 text-blue-600 text-[10px] font-black uppercase tracking-widest px-4 py-2 transition-all">Documentos</button>
        <button onclick="switchTab('tab-finance')" class="tab-btn border-b-2 border-transparent text-gray-400 text-[10px] font-black uppercase tracking-widest px-4 py-2 transition-all hover:text-blue-600">Faturamento</button>
        <button onclick="switchTab('tab-perfil')" class="tab-btn border-b-2 border-transparent text-gray-400 text-[10px] font-black uppercase tracking-widest px-4 py-2 transition-all hover:text-blue-600">Dados Pessoais</button>
    </div>

    <div id="tab-docs" class="tab-content fade-in">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-10">
            <div class="glass p-10 rounded-[40px] premium-shadow text-center flex flex-col items-center justify-center">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-6">Sincroniza√ß√£o</p>
                <div id="statusLed" class="text-5xl mb-2">‚óè</div>
                <h3 id="statusTxt" class="text-[10px] font-bold uppercase tracking-widest">---</h3>
            </div>
            <div class="glass p-10 rounded-[40px] premium-shadow flex flex-col justify-center">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-6">Servi√ßos</p>
                <h3 id="servicoTxt" class="text-xl font-bold italic tracking-tighter text-gray-900">---</h3>
                <p class="text-[10px] text-gray-400 font-medium uppercase tracking-widest mt-2 italic">Certificado pela ASYNCX</p>
            </div>
            <div class="glass p-10 rounded-[40px] premium-shadow flex flex-col justify-center">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-6 text-center">Laudos & Relat√≥rios</p>
                <div id="docsList" class="space-y-3"></div>
            </div>
        </div>
    </div> <div id="tab-finance" class="tab-content hidden fade-in">
        <div class="glass p-10 rounded-[40px] premium-shadow">
            <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-8 text-center">Hist√≥rico Financeiro & Pagamentos</p>
            <div id="financeList" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <div id="tab-perfil" class="tab-content hidden fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass p-10 rounded-[40px] premium-shadow">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-6">Informa√ß√µes Cadastrais</p>
                <div class="space-y-4">
                    <div>
                        <label class="text-[8px] font-black text-blue-600 uppercase">Documento</label>
                        <p id="perfilDoc" class="text-sm font-bold text-gray-800 uppercase italic">---</p>
                    </div>
                    <div>
                        <label class="text-[8px] font-black text-blue-600 uppercase">Endere√ßo</label>
                        <p id="perfilEnd" class="text-sm font-bold text-gray-800 uppercase italic">---</p>
                    </div>
                </div>
            </div>
            <div class="glass p-10 rounded-[40px] premium-shadow">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-6 text-center">Seguran√ßa da Conta</p>
                
                <div class="relative mb-4">
                    <input type="password" id="novaSenha" placeholder="Nova Senha" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition text-xs pr-12">
                    <button type="button" onclick="toggleView('novaSenha')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.644C3.399 8.049 7.21 5 12 5c4.789 0 8.601 3.049 9.964 6.678a1.012 1.012 0 010 .644C20.6 15.951 16.79 19 12 19c-4.789 0-8.601-3.049-9.964-6.678z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>

                <div class="relative mb-4">
                    <input type="password" id="confirmarNovaSenha" placeholder="Confirmar Nova Senha" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition text-xs pr-12">
                    <button type="button" onclick="toggleView('confirmarNovaSenha')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.644C3.399 8.049 7.21 5 12 5c4.789 0 8.601 3.049 9.964 6.678a1.012 1.012 0 010 .644C20.6 15.951 16.79 19 12 19c-4.789 0-8.601-3.049-9.964-6.678z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>

                <input type="text" id="mfaAtualizarSenha" placeholder="C√ìDIGO AUTHENTICATOR" maxlength="6" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition mb-4 text-center font-bold tracking-widest text-xs">
                
                <button onclick="atualizarSenha()" class="w-full bg-black text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition shadow-lg">Atualizar Senha</button>
            </div>
        </div>
    </div>
</main>

    <footer class="bg-white border-t border-gray-100 pt-20 pb-10 mt-auto">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center text-[10px] font-bold text-gray-300 uppercase tracking-widest text-center md:text-left gap-4">
                <p>¬© 2026 ASYNCX SOLUTIONS. TODOS OS DIREITOS RESERVADOS.</p>
                <p>INTELIG√äNCIA EM TI E SEGURAN√áA DIGITAL</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = 'https://asyncx-backend.onrender.com/api';
        // Fun√ß√£o central para validar for√ßa da senha
        function validarForcaSenha(senha) {
            const minComprimento = senha.length >= 8;
            const temMaiuscula = /[A-Z]/.test(senha);
            const temNumero = /[0-9]/.test(senha);
            const temEspecial = /[!@#$%^&*(),.?":{}|\/|<>]/.test(senha);

            if (!minComprimento) return "A senha deve ter no m√≠nimo 8 caracteres.";
            if (!temMaiuscula) return "A senha deve conter ao menos uma letra mai√∫scula.";
            if (!temNumero) return "A senha deve conter ao menos um n√∫mero.";
            if (!temEspecial) return "A senha deve conter ao menos um caractere especial.";
            
            return null; // Senha v√°lida
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const setupToken = urlParams.get('setup');
            
            // 1. Prioridade: Se for um link de primeiro acesso/reset
            if (setupToken) {
                carregarSetup(setupToken);
                return; // Para aqui para n√£o tentar carregar dashboard
            }

            // 2. Verifica√ß√£o de Sess√£o: Se j√° existe um token salvo
            const tokenSalvo = sessionStorage.getItem('asyncx_token');
            if (tokenSalvo) {
                // Se tem token, tenta carregar o dashboard direto
                // Passamos um objeto vazio ou com nome b√°sico, pois o dashboard vai buscar os dados reais com o token
                carregarDashboard({ nome: "" });
            }

            // 3. Banner de Cookies
            const consent = localStorage.getItem('asyncx_privacy_consent');
            if (!consent) {
                const banner = document.getElementById('cookieBanner');
                if (banner) banner.classList.remove('hidden');
            }
        }

        let globalNeedsMFA = false;

        async function carregarSetup(token) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('setupSection').classList.remove('hidden');
            try {
                const res = await fetch(`${API_URL}/auth/setup-check/${token}`);
                const data = await res.json();
                
                if (data.success) {
                    globalNeedsMFA = data.needsMFA; // Backend informa se precisa de QR Code
                    
                    document.getElementById('setupNome').innerText = globalNeedsMFA 
                        ? `Ol√°, ${data.nome.split(' ')[0]}` 
                        : `Recupera√ß√£o: ${data.nome.split(' ')[0]}`;

                    const mfaContainer = document.getElementById('mfaContainer');
                    
                    if (!globalNeedsMFA) {
                        // Se for reset, esconde QR Code e Links das Lojas
                        if (mfaContainer) mfaContainer.classList.add('hidden');
                        document.getElementById('btnFinalizar').innerText = "ATUALIZAR SENHA";
                    } else {
                        // Se for primeiro acesso, mostra tudo
                        if (mfaContainer) mfaContainer.classList.remove('hidden');
                        document.getElementById('qrCodeImg').src = data.qrCode;
                    }
                } else {
                    alert(data.message || "Link expirado.");
                    window.location.href = 'restrito.html';
                }
            } catch (err) { alert("Erro ao conectar com o servidor."); }
        }

        async function finalizarSetup() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('setup');
            const senha = document.getElementById('setupSenha').value;
            const confirma = document.getElementById('setupSenhaConfirm').value;
            const mfaToken = document.getElementById('setupMfa').value;
            const btn = document.getElementById('btnFinalizar');

            // 1. Valida√ß√£o de igualdade de senhas
            if (senha !== confirma) return alert("As senhas digitadas n√£o coincidem.");
            
            // 2. Valida√ß√£o de preenchimento (MFA s√≥ obrigat√≥rio se globalNeedsMFA for true)
            if (!senha || (globalNeedsMFA && !mfaToken)) {
                return alert("Preencha todos os campos de seguran√ßa obrigat√≥rios.");
            }

            // 3. Valida√ß√£o de for√ßa (Agora aceitando /)
            const erroSenha = validarForcaSenha(senha);
            if (erroSenha) return alert(erroSenha);

            btn.disabled = true;
            btn.innerText = "PROCESSANDO...";

            // 4. L√ìGICA DE DESVIO DE ROTA
            // Se for primeiro acesso -> setup-finalize (payload: senha)
            // Se for recupera√ß√£o -> complete-reset (payload: password)
            const endpoint = globalNeedsMFA ? '/auth/setup-finalize' : '/auth/complete-reset';
            const payload = globalNeedsMFA 
                ? { token, senha, mfaToken } 
                : { token, password: senha };

            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    alert(data.message || "Protocolo conclu√≠do com sucesso!");
                    window.location.href = 'restrito.html';
                } else {
                    alert(data.message);
                }
            } catch (err) {
                alert("Erro na ativa√ß√£o. Verifique sua conex√£o com a rede ASYNCX.");
            } finally {
                btn.disabled = false;
                btn.innerText = globalNeedsMFA ? "Finalizar Ativa√ß√£o" : "ATUALIZAR SENHA";
            }
        }

        async function fazerLogin() {
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const mfaToken = document.getElementById('mfaTokenLogin').value;
            const btn = document.getElementById('btnLogin');

            if(!email || !senha || !mfaToken) return alert("Preencha tudo.");
            
            btn.disabled = true;
            btn.innerText = "AUTENTICANDO...";

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha, mfaToken })
                });
                const result = await response.json();

                if (response.ok) {
                    // SALVA O TOKEN PARA REQUISI√á√ïES FUTURAS
                    sessionStorage.setItem('asyncx_token', result.token); 
                    
                    // Agora chamamos o dashboard sem precisar passar o email na m√£o
                    carregarDashboard(result.data);
                } else {
                    alert(result.message);
                }
            } catch (err) { 
                alert("Erro de conex√£o."); 
            } finally { 
                btn.disabled = false; 
                btn.innerText = "Entrar"; 
            }
        }
        async function carregarDashboard(userBasicData) {
            // 1. Setup inicial de visibilidade
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('btnSair').classList.remove('hidden');
            const statusTxt = document.getElementById('statusTxt');
            const clienteNome = document.getElementById('clienteNome');
            
            if (clienteNome) clienteNome.innerText = "VALIDANDO SESS√ÉO...";
            if (statusTxt) statusTxt.innerText = "VERIFICANDO CREDENCIAIS...";
            // 2. Feedback imediato com o nome do login (se dispon√≠vel)
            if (userBasicData.nome) {
                document.getElementById('clienteNome').innerText = userBasicData.nome.toUpperCase();
            }

            // Recupera o Token JWT do sessionStorage para autenticar a requisi√ß√£o
            const token = sessionStorage.getItem('asyncx_token');

            try {
                // REQUISI√á√ÉO PROTEGIDA: A URL agora √© gen√©rica, o servidor identifica o usu√°rio pelo Token
                const response = await fetch(`${API_URL}/user/dashboard-data`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();

                if (data.success) {
                    const p = data.perfil;

                    // 3. Renderizar DADOS PESSOAIS (Aba Perfil)
                    document.getElementById('clienteNome').innerText = p.NOME_EXIBICAO.toUpperCase();
                    document.getElementById('perfilDoc').innerText = p.DOCUMENTO_IDENTIDADE || "N√ÉO INFORMADO";
                    document.getElementById('perfilEnd').innerText = p.ENDERECO_COMPLETO || "N√ÉO INFORMADO";
                    
                    // 4. Status e Dispositivos (L√≥gica H√≠brida Mensal vs Avulso)
                    const led = document.getElementById('statusLed');
                    const txt = document.getElementById('statusTxt');
                    const servTxt = document.getElementById('servicoTxt');

                    if (p.TIPO_SERVICO === 'MENSAL') {
                        // Configura√ß√£o para Monitoramento Ativo (Verde Pulsante)
                        led.className = "text-5xl mb-2 led-pulse"; // Usa a nova classe CSS verde
                        txt.innerText = `PROTEGIDO (${p.QTD_DISPOSITIVOS} DEVICES)`;
                        txt.className = "text-[10px] font-bold uppercase tracking-widest text-green-600";
                        servTxt.innerText = "Monitoramento Ativo";
                    } else {
                        // Configura√ß√£o para Servi√ßos Avulsos (Azul Fixo)
                        led.className = "text-5xl mb-2 led-fixed"; // Usa a nova classe CSS azul
                        txt.innerText = "SERVI√áO CONCLU√çDO";
                        txt.className = "text-[10px] font-bold uppercase tracking-widest text-blue-600";
                        servTxt.innerText = "Servi√ßos Diversos";
                    }

                    // 5. Renderizar DOCUMENTOS (Tabela ASYNCX_DOCUMENTS)
                    const dList = document.getElementById('docsList');
                    dList.innerHTML = ''; 
                    if (data.documentos && data.documentos.length > 0) {
                        data.documentos.forEach(doc => {
                            const btn = document.createElement('a');
                            btn.href = doc.URL_PDF; 
                            btn.target = "_blank";
                            btn.className = "block w-full text-center py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest bg-gray-50 text-gray-800 border border-gray-100 hover:bg-white hover:border-blue-600 transition mb-2";
                            btn.innerText = `üìÑ ${doc.NOME_EXIBICAO}`;
                            dList.appendChild(btn);
                        });
                    } else {
                        dList.innerHTML = '<p class="text-[10px] text-gray-400 uppercase text-center py-4">Nenhum laudo dispon√≠vel</p>';
                    }

                    // 6. Renderizar FINANCEIRO (Tabela ASYNCX_BILLING)
                    const fList = document.getElementById('financeList');
                    fList.innerHTML = ''; 

                    if (data.financeiro && data.financeiro.length > 0) {
                        data.financeiro.forEach(bill => {
                            const div = document.createElement('div');
                            
                            // Defini√ß√£o de Cores e Estilos baseada no Status
                            const isPago = bill.STATUS_PAGO === 'PAGO';
                            const statusClasse = isPago ? 'status-pago' : 'status-pendente';
                            const btnTexto = isPago ? 'RECIBO' : 'EFETUAR PAGAMENTO';
                            const btnClasse = isPago ? 'bg-emerald-600' : 'bg-black';

                            div.className = `glass p-6 rounded-[30px] flex justify-between items-center border border-slate-50 hover:shadow-lg transition-all duration-300 w-full mb-4`;
                            
                            const dataVenc = new Date(bill.DATA_VENCIMENTO).toLocaleDateString('pt-BR');
                            
                            div.innerHTML = `
                                <div class="flex flex-col gap-1 flex-1">
                                    <span class="px-3 py-1 rounded-full text-[7px] font-black uppercase tracking-tighter w-fit ${statusClasse}">
                                        ${bill.STATUS_PAGO}
                                    </span>
                                    <p class="text-[10px] font-black text-gray-800 uppercase mt-2">${bill.DESCRICAO || 'Servi√ßo de Seguran√ßa'}</p>
                                </div>

                                <div class="hidden md:flex flex-col items-center flex-1">
                                    <p class="text-[11px] font-black text-blue-600">R$ ${Number(bill.VALOR).toFixed(2)}</p>
                                    <p class="text-[8px] text-gray-400 uppercase font-bold tracking-widest">Vencimento: ${dataVenc}</p>
                                </div>

                                <div class="flex flex-col items-end flex-1">
                                    <a href="${bill.LINK_BOLETO || '#'}" target="_blank" 
                                    class="${btnClasse} text-white px-6 py-3 rounded-2xl text-[8px] font-black uppercase tracking-widest hover:opacity-80 transition shadow-md">
                                        ${btnTexto}
                                    </a>
                                    <p class="md:hidden text-[7px] text-gray-400 uppercase font-bold mt-1">${dataVenc}</p>
                                </div>
                            `;
                            fList.appendChild(div);
                        });
                    } else {
                        fList.innerHTML = '<p class="text-[9px] text-gray-400 italic text-center col-span-2 py-8 uppercase font-bold tracking-widest">Aguardando gera√ß√£o de faturamento...</p>';
                    }

                } else {
                    console.error("Erro no retorno dos dados:", data.message);
                    if(data.message === "Acesso negado." || data.message === "Sess√£o inv√°lida ou expirada.") {
                        alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
                        window.location.reload();
                    }
                }
            } catch (err) { 
                console.error("Erro t√©cnico na chamada do Dashboard:", err);
            }
            window.scrollTo(0,0);
        }

        function switchTab(tabId) {
            // Esconde todos os conte√∫dos
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // Mostra o conte√∫do selecionado
            document.getElementById(tabId).classList.remove('hidden');

            // Estiliza os bot√µes (remove o azul do anterior e coloca no atual)
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-400');
            });

            // Destaca o bot√£o clicado (quem chamou a fun√ß√£o)
            event.currentTarget.classList.remove('border-transparent', 'text-gray-400');
            event.currentTarget.classList.add('border-blue-600', 'text-blue-600');
        }

       async function atualizarSenha() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confirma = document.getElementById('confirmarNovaSenha').value;
            const mfaToken = document.getElementById('mfaAtualizarSenha').value;
            const token = sessionStorage.getItem('asyncx_token');

            // Valida√ß√£o de confirma√ß√£o
            if (novaSenha !== confirma) return alert("A confirma√ß√£o da nova senha n√£o coincide.");
            
            const erroSenha = validarForcaSenha(novaSenha);
            if (erroSenha) return alert(erroSenha);
            if (!mfaToken) return alert("Digite o c√≥digo MFA para confirmar.");

            try {
                const res = await fetch(`${API_URL}/user/change-password`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ novaSenha, mfaToken })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert("Senha atualizada com sucesso!");
                    document.getElementById('novaSenha').value = '';
                    document.getElementById('confirmarNovaSenha').value = '';
                    document.getElementById('mfaAtualizarSenha').value = '';
                } else {
                    alert(data.message);
                }
            } catch (e) { alert("Erro no servidor."); }
        }
        
        function sair() {

            sessionStorage.removeItem('asyncx_token');
            sessionStorage.clear();
            alert("Sess√£o encerrada.");
            window.location.href = 'restrito.html';
        }

       function toggleEsqueciSenha(mostrar) {
            const loginFields = document.getElementById('loginFields');
            const forgotSection = document.getElementById('forgotSection');
            const titulo = document.getElementById('tituloAcesso');
            const label = document.getElementById('labelAcesso');
            
            if(mostrar) {
                loginFields.classList.add('hidden');
                forgotSection.classList.remove('hidden');
                titulo.innerHTML = "Recuperar <br>Minha Senha";
                label.innerText = "Seguran√ßa ASYNCX";
            } else {
                loginFields.classList.remove('hidden');
                forgotSection.classList.add('hidden');
                titulo.innerHTML = "Painel de <br>Seguran√ßa";
                label.innerText = "Acesso Restrito";
            }
        }

        async function solicitarReset() {
            const email = document.getElementById('emailForgot').value;
            const btn = document.getElementById('btnForgot');

            if(!email) return alert("Informe seu e-mail.");

            // Desabilita para evitar cliques duplos
            btn.disabled = true;
            btn.innerText = "PROCESSANDO...";
            console.log("Iniciando solicita√ß√£o de reset para:", email);

            try {
                const response = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const result = await response.json();
                console.log("Resposta do servidor:", result);

                if (response.ok) {
                    alert("Sucesso! Verifique sua caixa de entrada (e a pasta de spam) em instantes.");
                    // Limpa o campo e volta para a tela de login
                    document.getElementById('emailForgot').value = '';
                    toggleEsqueciSenha(false);
                } else {
                    alert(result.message || "Erro ao processar solicita√ß√£o.");
                }
            } catch (err) {
                console.error("Erro na requisi√ß√£o:", err);
                alert("Erro ao conectar com o servidor ASYNCX. Verifique sua conex√£o.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Enviar Link de Recupera√ß√£o"; // Texto original exato
            }
        }

        function toggleView(id) {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        }

    </script>
</body>
</html>